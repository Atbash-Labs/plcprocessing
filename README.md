# CODESYS Scripting API Tools

A collection of Python tools for exporting, diffing, and applying changes to CODESYS projects using the **CODESYS Scripting API**. This approach solves the broken PLCOpenXML export/import cycle by using CODESYS's native API, which exports/imports correctly.

## Why Scripting API Instead of XML?

**Problem**: CODESYS V3.x GUI PLCOpenXML export/import is broken - exported XML files cannot be re-imported.

**Solution**: Use the CODESYS Scripting API which:
- ✅ Exports XML that actually works
- ✅ Direct project manipulation (no export/import cycle)
- ✅ Can run headless for CI/CD
- ✅ Full access to project structure
- ✅ Well-documented with active community

## Project Structure

```
.
├── scripts/              # Main CODESYS Scripting API tools
│   ├── codesys_export.py          # Export project to .st files
│   ├── codesys_import.py          # Import .st files to project (runs in CODESYS)
│   ├── codesys_import_external.py # Import wrapper (runs outside CODESYS)
│   ├── codesys_diff.py            # Generate diffs between exports
│   ├── codesys_apply.py            # Apply diffs to exports
│   └── codesys_apply_diff_to_project.py  # End-to-end workflow
├── legacy/              # Legacy XML-based tools (deprecated)
│   ├── plcopenxmlprocessor.py
│   ├── plcopenxmlmerge.py
│   └── ...
├── tests/               # Test files and outputs
└── docs/                 # Documentation
```

## Quick Start

### Export Project

**Inside CODESYS:**
```
Tools → Execute Script → scripts/codesys_export.py
```

**Headless:**
```bash
CODESYS.exe --noUI --profile="CODESYS V3.5 SP21 Patch 3" \
  --runscript="scripts/codesys_export.py" \
  "C:\Projects\MyProject.project" \
  "C:\Export"
```

### Import Project

**From outside CODESYS:**
```bash
python scripts/codesys_import_external.py \
  "C:\Projects\MyProject.project" \
  "C:\Import" \
  --codesys-path "C:\Program Files\CODESYS 3.5.21.30\CODESYS\Common\CODESYS.exe"
```

### Apply Diff to Project

```bash
python scripts/codesys_apply_diff_to_project.py \
  "C:\Projects\MyProject.project" \
  "C:\Diffs" \
  --codesys-path "C:\Program Files\CODESYS 3.5.21.30\CODESYS\Common\CODESYS.exe"
```

## Tools

### `scripts/codesys_export.py`
Exports CODESYS project to text format using Scripting API. Exports POUs and GVLs as `.st` files for source control and diffing.

**Output Format:**
- POUs: `POU_NAME.prg.st`, `POU_NAME.fb.st`, `POU_NAME.fun.st`
- GVLs: `GVL_NAME.gvl.st`
- Methods: `POU_METHOD.meth.st`
- Each file contains declaration and implementation sections

### `scripts/codesys_import.py`
Imports text files back into CODESYS project using Scripting API. Reads `.st` files and applies them to the project.

**Features:**
- Creates new POUs/GVLs/methods
- Updates existing POUs/GVLs/methods
- Merges variables in GVLs (adds new variables without removing existing ones)

### `scripts/codesys_diff.py`
Compares two directories of CODESYS text exports and generates unified diffs for source control.

**Output:**
- `.diff` files for modified files
- `.added` files for new files
- `.removed` files for deleted files
- `diff_summary.txt` with summary

### `scripts/codesys_apply.py`
Applies unified diffs (generated by `codesys_diff.py`) to a target directory of `.st` files.

### `scripts/codesys_apply_diff_to_project.py`
Complete end-to-end workflow: export project, apply diff, and import back into the project.

## Workflow

1. **Export** project → `.st` files
2. **Diff** two exports → unified diff files
3. **Apply** diff to export → modified `.st` files
4. **Import** modified files → back into CODESYS project

## Requirements

- CODESYS V3.5 SP21 or later
- Python 3.x (for external scripts)
- IronPython (for scripts running inside CODESYS)

## See Also

- [docs/import_instructions.md](docs/import_instructions.md) - Detailed import instructions
- [docs/README_DIFF.md](docs/README_DIFF.md) - Diff format documentation
